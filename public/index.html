<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoiChat</title>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <section class="wrapper">
        <h1>Noi<span class="span">C</span>hat</h1>

        <nav class="inputs">
            <input type="text" placeholder="Type here / double - click to select image" class="msg" id="msg">
            <input type="file" id="imgInput" accept="image/*" style="display: none;">
            <button class="btn" id="sndbtn"><img src="./img/send.svg" alt="Send" height="40px"></button>
        </nav>

        <div class="screen" id="screen">
            <img src="./img/background.png" class="chat-back">
            <div class="display-cont" id="display-cont"></div>
        </div>
    </section>
    <a href="https://www.logicode.site" class="ref">logicode.site</a>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // const socket = io("https://chat-n8s4.onrender.com");
        const socket = io();
        const msg = document.getElementById('msg');
        const sndbtn = document.getElementById('sndbtn');
        const screen = document.getElementById('screen');
        const displayCont = document.getElementById('display-cont');

        // Load messages from localStorage on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedMessages = JSON.parse(localStorage.getItem('chatHistory')) || [];
            savedMessages.forEach(msgObj => renderMessage(msgObj));
        });

        function saveMessage(msg) {
            const current = JSON.parse(localStorage.getItem('chatHistory')) || [];
            current.push(msg);
            localStorage.setItem('chatHistory', JSON.stringify(current));
        }

        function renderMessage(msgObj) {
            const { content, sender } = msgObj;
            const p = document.createElement("p");

            if (content.startsWith("data:image")) {
                const label = document.createElement("strong");
                label.textContent = `${sender}: `;
                p.appendChild(label);
                const img = document.createElement("img");
                img.src = content;
                img.style.maxWidth = "200px";
                img.style.borderRadius = "10px";
                p.appendChild(img);
            } else {
                p.innerText = `${sender}: ${content}`;
            }

            const now = new Date();
            const h = now.getHours().toString().padStart(2, '0');
            const m = now.getMinutes().toString().padStart(2, '0');

            const span = document.createElement("span");
            span.textContent = `${h}:${m}`;
            p.appendChild(span);

            if (content.trim() === "") {
                p.style.display = "none";
            } else {
                p.style.display = "flex";
            }

            p.style.borderLeftWidth = "2px";
            p.style.borderLeftStyle = "solid";
            p.style.borderLeftColor = sender === "me" ? "blue" : "red";

            displayCont.appendChild(p);
            p.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        socket.on("msgs", (msgObj) => {
            const isMine = msgObj.sender === 'me';
            const displaySender = isMine ? 'me' : 'other';
            const displayMsg = { ...msgObj, sender: displaySender };
            renderMessage(displayMsg);
            saveMessage(displayMsg);
        });

        const imgInput = document.getElementById('imgInput');

        sndbtn.addEventListener('click', () => {
            const msgs = msg.value.trim();
            const file = imgInput.files[0];

            // If there's an image selected
            if (file) {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result;
                    socket.emit('msg', { content: base64, sender: 'me' });
                    imgInput.value = ""; // Reset file input
                };
                reader.readAsDataURL(file);
            }

            // If there's a text message
            if (msgs !== "") {
                socket.emit('msg', { content: msgs, sender: 'me' });
                msg.value = "";
            }
        });

        // Optional: Double-click on textarea to open file picker
        msg.addEventListener('dblclick', () => {
            imgInput.click();
        });

        msg.addEventListener('keydown', (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                sndbtn.click();
                msg.value = "";
            }
        });
    </script>
</body>
</html>